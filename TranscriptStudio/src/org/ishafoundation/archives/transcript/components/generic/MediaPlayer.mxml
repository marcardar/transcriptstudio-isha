<?xml version="1.0" encoding="utf-8"?>
<mx:Box xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%">
	<mx:Script>
    <![CDATA[
    	import org.ishafoundation.archives.transcript.db.DatabaseConstants;
    	import flash.utils.getTimer;
    	import flash.net.sendToURL;
    	import mx.managers.PopUpManager;
    	import mx.core.UIComponent;
		import com.jeroenwijering.events.*;
		import mx.events.ResizeEvent;

		[Bindable]
		/* Pass FlashVars to the Player here.  Player.swf should be in the source root of your Flex application */
		private var file:String = "player.swf?autostart=true&controlbar=over&resizing=false";

		private var playerObject : Object;
		private var seek:Boolean = true;
		private var pause:Boolean = true;
		private var start:int = 1000;
		
		/* This method is called when the SWFLoader has completed its loading and the Player has been initialized.  Due
		    to timing issues, we have to check whether the player's view has been loaded or not.  If not, listen to the 
		    Player's new PlayerEvent.READY event.
		 */
		private function loaderFinished(e:Event) : void {
			playerObject = e.target.content as Object;

			if(playerObject.view == null) {
				playerObject.addEventListener(PlayerEvent.READY, this.playerReady);
			} else {
				playerReady();
			}
		}
		
		/* Once the Player has been initialized, we can begin to send and receive events from it */
		private function playerReady(e:Event=null) : void {
			// Wait for the view to load the file.
			trace(getTimer() + ": Player ready");
			playerObject.view.addViewListener(ViewEvent.LOAD, loadHandler);
			playerObject.view.sendEvent(ViewEvent.LOAD, {type:"video",file:DatabaseConstants.EXIST_URL + "/archives/transcript/media/N866.mp4"});
			playerObject.view.addModelListener(ModelEvent.LOADED, loadedHandler);
			playerObject.view.addModelListener(ModelEvent.BUFFER, bufferHandler);
			
			// Set the player screen to the correct dimensions.
			resizePlayer();
		} 
		
		/* The event loading the file has fired, we can now start the video playback. */
		private function loadHandler(e:Event=null):void {
			trace(getTimer() + ": Load");				

			playerObject.view.addModelListener(ModelEvent.TIME, timeHandler);
			//seekHandler();
			/*playerObject.view.addViewListener(ViewEvent.PLAY, playHandler);
			playerObject.view.sendEvent(ViewEvent.PLAY, true);
			playerObject.view.sendEvent("scrub", 5);*/
			//playerObject.view.sendEvent(ViewEvent.PLAY, true);
		}
		
		private function bufferHandler(e:ModelEvent):void {
			trace(getTimer() + ": Buffer");
		}
		
		/* The event loading the file has fired, we can now start the video playback. */
		private function loadedHandler(e:ModelEvent=null):void {
			trace(getTimer() + ": Loaded: " + (e as ModelEvent).data["loaded"] + " bytes");
		}
		
		private function playHandler(e:Event = null):void {
			trace(getTimer() + ": play event: " + e);
			//playerObject.view.sendEvent(ViewEvent.PLAY, true);
		}

		private function seekHandler(e:Event = null):void {
			trace(getTimer() + ": seek event: " + e);
		}
		
		/* To resize the player, simply set its width and height, and send the view a ViewEvent.REDRAW event. */
		private function resizePlayer() : void {
			if(playerObject != null && playerObject.view != null) {
				playerObject.config['width'] = player.width;
				playerObject.config['height'] = player.height;
				playerObject.view.sendEvent(ViewEvent.REDRAW);
			}

		}

		/* Respond to time events */
		private function timeHandler(me:ModelEvent) : void {
			if (me.data.position > 0) {
				seekIfNecessary();
			}
			
			//timelabel.text = "Time tracker: " + me.data.position;
		}
		
		private function seekIfNecessary():void {
			// && (true || me.data["loaded"] > 90000 * start
			if (seek) {
				trace("Seeking to: " + start);
				playerObject.view.addViewListener(ViewEvent.SEEK, seekHandler);
				playerObject.view.sendEvent(ViewEvent.SEEK, start);
				//playerObject.view.sendEvent(ViewEvent.MUTE, false);
				seek = false;
			}			
		}
    	
    	public static function display(parent:DisplayObject):MediaPlayer {
    		var result:MediaPlayer = new MediaPlayer();
			PopUpManager.addPopUp(result, parent, true);
			return result;
    	}
    
		private function closeMe():void {
        	PopUpManager.removePopUp(this);
		}
		
		private function skipClicked():void {
			playerObject.view.sendEvent(ViewEvent.SEEK, 5);
		}		
    ]]>
	</mx:Script>
	<!-- Load the Player's SWF here.  Make sure to turn off the aspect ratio and scaling properties. -->
	<mx:SWFLoader id="player" source="{file}"
		maintainAspectRatio="false" scaleContent="false" 
		width="100%" height="100%"
		init="loaderFinished(event);"
		resize="resizePlayer();">
	</mx:SWFLoader>
</mx:Box>
