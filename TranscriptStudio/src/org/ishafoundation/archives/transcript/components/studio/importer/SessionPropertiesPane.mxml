<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="creationCompleteHandler()" paddingLeft="10" paddingRight="10" paddingTop="10" paddingBottom="10">
	<mx:Script>
	<![CDATA[
		import org.ishafoundation.archives.transcript.model.ReferenceManager;
		import org.ishafoundation.archives.transcript.model.EventProperties;
		import mx.controls.Alert;
		import org.ishafoundation.archives.transcript.model.SessionProperties;
		import mx.events.PropertyChangeEvent;
		import mx.binding.utils.ChangeWatcher;
		import name.carter.mark.flex.util.collection.HashSet;
		import org.ishafoundation.archives.transcript.fs.SessionFile;
		import org.ishafoundation.archives.transcript.fs.EventFile;
		import name.carter.mark.flex.util.collection.ISet;
		import mx.utils.StringUtil;
		import mx.formatters.DateBase;
		import name.carter.mark.flex.util.Utils;
		import org.ishafoundation.archives.transcript.util.IdUtils;
		import name.carter.mark.flex.util.XMLUtils;
		import mx.collections.ArrayCollection;
		
		[Bindable]
		public var referenceMgr:ReferenceManager;
		
		private var _sessionProps:SessionProperties;
		private var _eventFile:EventFile;
		[Bindable]
		public var eventProps:EventProperties;

		private function creationCompleteHandler():void {
			var hourArr:Array = [];
			for (var hour:int = 0; hour < 24; hour++) {
				var hourStr:String = hour.toString();
				while (hourStr.length < 2) {
					hourStr = "0" + hourStr;
				}
				hourArr.push(hourStr);
			}
			hourComboBox.dataProvider = hourArr;
			hourComboBox.selectedIndex = hourArr.length / 2;
			var minuteArr:Array = [];
			for (var minute:int = 0; minute < 60; minute++) {
				var minuteStr:String = minute.toString();
				if (minute % 15 == 0) {
					while (minuteStr.length < 2) {
						minuteStr = "0" + minuteStr;
					}
					minuteArr.push(minuteStr);
				}
			}
			minuteComboBox.dataProvider = minuteArr;
			//minuteComboBox.selectedIndex = minuteArr.length / 2;
		}
		
		[Bindable]
		public function get sessionProps():SessionProperties {
			return _sessionProps;
		}
		
		public function set sessionProps(newProps:SessionProperties):void {
			if (newProps === _sessionProps) {
				return;
			}
			_sessionProps = newProps;
			sessionSubTitleTextInput.text = _sessionProps.subTitle;
			var startAt:Date = _sessionProps.startAt;
			startAtDateField.selectedDate = startAt;
			if (_sessionProps.startAtIncludesTime()) {
				unknownTimeCheckBox.selected = false;
				hourComboBox.selectedItem = fixWidth(startAt.hours, 2);
				minuteComboBox.selectedItem = fixWidth(startAt.minutes, 2);
			}
			else {
				unknownTimeCheckBox.selected = true;
			}
			startAtChangeHandler();
			commentTextArea.text = _sessionProps.comment;
		}
		
		private static function fixWidth(value:int, minLength:int):String {
			var result:String = value.toString();
			while (result.length < minLength) {
				result = "0" + result;
			} 
			return result;
		}
		
		[Bindable]
		public function get eventFile():EventFile {
			return _eventFile;
		}
		
		public function set eventFile(newValue:EventFile):void {
			if (newValue == null) {
				throw new ArgumentError("Passed a null eventFile");
			}
			this._eventFile = newValue;
		}
		
		private static function generateFullTitle(eventProps:EventProperties, referenceMgr:ReferenceManager):String {
			var result:String = referenceMgr.getEventTypeName(eventProps.type);
			if (eventProps.subTitle != null) {
				result += " - " + eventProps.subTitle;
			}
			return result;
		}
		
		private function startAtChangeHandler():void {
			var startAt:Date = startAtDateField.selectedDate;
			if (startAt == null) {
				sessionProps.setStartAt(null, false);
			}
			else {
				// maybe we need to incorporate the time too
				if (!unknownTimeCheckBox.selected) {
					startAt.hours = int(hourComboBox.selectedItem);
					startAt.minutes = int(minuteComboBox.selectedItem);
					sessionProps.setStartAt(startAt, true);
				}
				else {
					sessionProps.setStartAt(startAt, false);
				}
			}
			mainGrid.executeChildBindings(true);
		} 
		
	]]>
	</mx:Script>
	<mx:Boolean id="ready">{true}</mx:Boolean>
	<mx:Grid id="mainGrid" width="100%" height="100%">
		<mx:GridRow width="100%">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="middle">
				<mx:Label text="Session Title"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:Label width="100%" text="{generateFullTitle(eventProps, referenceMgr)}"/>
			</mx:GridItem>
		</mx:GridRow>
		<mx:GridRow width="100%">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="middle">
				<mx:Label text="Session Sub Title"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:TextInput width="100%" id="sessionSubTitleTextInput" change="{sessionProps.subTitle = sessionSubTitleTextInput.text}"/>
			</mx:GridItem>
		</mx:GridRow>
		<mx:GridRow width="100%">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="middle">
				<mx:Label text="Session Date"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:DateField id="startAtDateField" formatString="DD/MM/YYYY" change="{startAtChangeHandler()}"/>
			</mx:GridItem>
		</mx:GridRow>
		<mx:GridRow width="100%" enabled="{startAtDateField.selectedDate != null}">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="middle">
				<mx:Label text="Scheduled Start Time"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:HBox horizontalGap="2" enabled="{!unknownTimeCheckBox.selected}" verticalAlign="middle">
					<mx:ComboBox width="55" id="hourComboBox" rowCount="13" change="{startAtChangeHandler()}"/>
					<mx:Label text=":" textAlign="center" maxWidth="10"/>
					<mx:ComboBox width="55" id="minuteComboBox" rowCount="12" change="{startAtChangeHandler()}"/>
					<mx:Label text="(hh:mm)"/>					
				</mx:HBox>
				<mx:CheckBox label="unknown" labelPlacement="left" width="100%" textAlign="right" id="unknownTimeCheckBox" change="{startAtChangeHandler()}"/>
			</mx:GridItem>
		</mx:GridRow>
		<mx:GridRow width="100%" height="100%">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="top" paddingTop="2">
				<mx:Label text="Notes"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:TextArea id="commentTextArea" width="100%" height="100%" change="{sessionProps.comment = commentTextArea.text}"/>
			</mx:GridItem>
		</mx:GridRow>
	</mx:Grid>
</mx:VBox>
