<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="creationCompleteHandler()" paddingLeft="10" paddingRight="10" paddingTop="10" paddingBottom="10">
	<mx:Script>
	<![CDATA[
		import mx.controls.Alert;
		import org.ishafoundation.archives.transcript.model.SessionProperties;
		import mx.events.PropertyChangeEvent;
		import mx.binding.utils.ChangeWatcher;
		import name.carter.mark.flex.util.collection.HashSet;
		import org.ishafoundation.archives.transcript.fs.SessionFile;
		import org.ishafoundation.archives.transcript.fs.EventFile;
		import name.carter.mark.flex.util.collection.ISet;
		import mx.utils.StringUtil;
		import mx.formatters.DateBase;
		import name.carter.mark.flex.util.Utils;
		import org.ishafoundation.archives.transcript.util.IdUtils;
		import name.carter.mark.flex.util.XMLUtils;
		import mx.collections.ArrayCollection;
		
		private var _sessionProps:SessionProperties;
		private var _eventFile:EventFile;
		[Bindable]
		private var existingSessionIndexes:ISet;

		[Bindable]		
		private var idAlreadyExists:Boolean;
		
		private function creationCompleteHandler():void {
			sessionIndexBox.dataProvider = EventPropertiesPane.getArrayCollectionSequence(1, 99, 2, false);
			sessionIndexChangeHandler();
		}
		
		[Bindable]
		public function get sessionProps():SessionProperties {
			return _sessionProps;
		}
		
		public function set sessionProps(newProps:SessionProperties):void {
			if (newProps === _sessionProps) {
				return;
			}
			_sessionProps = newProps;
			sessionNameTextInput.text = _sessionProps.name;
			startAtDateField.selectedDate = _sessionProps.startAt;
			commentTextArea.text = _sessionProps.comment;
			sessionIndexChangeHandler();
		}
		
		[Bindable]
		public function get eventFile():EventFile {
			return _eventFile;
		}
		
		public function set eventFile(newValue:EventFile):void {
			if (newValue == null) {
				throw new ArgumentError("Passed a null eventFile");
			}
			this._eventFile = newValue;
			var existingSessions:Array = eventFile.getSessionFiles();
			this.existingSessionIndexes = new HashSet();
			var existingSessionIndexArray:Array = existingSessions.map(function (sessionFile:SessionFile, index:int, arr:Array):int {
				return sessionFile.sessionIndex;
			});
			this.existingSessionIndexes.addAll(existingSessionIndexArray);
			sessionIndexChangeHandler();			
		}
		
		private function sessionIndexChangeHandler():void {
			if (sessionProps == null || eventFile == null) {
				return;
			}
			var sessionIndex:int = new uint(sessionIndexBox.text);
			idAlreadyExists = existingSessionIndexes.contains(sessionIndex);
			sessionProps.id = eventFile.nodeId + 's' + sessionIndexBox.text;
		}
	]]>
	</mx:Script>
	<mx:Boolean id="ready">{!idAlreadyExists &amp;&amp; StringUtil.trim(sessionNameTextInput.text).length > 0}</mx:Boolean>
	<mx:Grid width="100%" height="100%">
		<mx:GridRow width="100%">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="middle">
				<mx:Label text="Session Name"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:TextInput width="100%" id="sessionNameTextInput" change="{sessionProps.name = sessionNameTextInput.text}"/>
			</mx:GridItem>
		</mx:GridRow>
		<mx:GridRow width="100%">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="middle">
				<mx:Label text="Session Date"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:DateField id="startAtDateField" formatString="DD/MM/YYYY" change="{sessionProps.startAt = startAtDateField.selectedDate}"/>
			</mx:GridItem>
		</mx:GridRow>
		<mx:GridRow width="100%">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="middle">
				<mx:Label text="Session Index"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:HBox width="100%" verticalAlign="middle">
					<mx:ComboBox id="sessionIndexBox" width="95" textAlign="center" change="{sessionIndexChangeHandler()}"/>
					<mx:Label text="{idAlreadyExists ? '- INDEX ALREADY IN USE' : ''}" color="#FF0000"/> 
				</mx:HBox>
			</mx:GridItem>
		</mx:GridRow>
		<mx:GridRow width="100%" height="100%">
			<mx:GridItem height="100%" horizontalAlign="right" verticalAlign="top" paddingTop="2">
				<mx:Label text="Notes"/>
			</mx:GridItem>
			<mx:GridItem width="100%" height="100%" verticalAlign="middle">
				<mx:TextArea id="commentTextArea" width="100%" height="100%" change="{sessionProps.comment = commentTextArea.text}"/>
			</mx:GridItem>
		</mx:GridRow>
	</mx:Grid>
</mx:VBox>
